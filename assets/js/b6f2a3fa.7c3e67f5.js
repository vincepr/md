"use strict";(self.webpackChunkmd=self.webpackChunkmd||[]).push([[5611],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>u});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},d=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},p="mdxType",E={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},m=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=c(t),m=r,u=p["".concat(l,".").concat(m)]||p[m]||E[m]||i;return t?a.createElement(u,o(o({ref:n},d),{},{components:t})):a.createElement(u,o({ref:n},d))}));function u(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=m;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[p]="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}m.displayName="MDXCreateElement"},6566:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=t(7462),r=(t(7294),t(3905));const i={},o="Postgres scripts of daily use",s={unversionedId:"postgres/scripts",id:"postgres/scripts",title:"Postgres scripts of daily use",description:"Kill long running queries",source:"@site/docs/postgres/scripts.md",sourceDirName:"postgres",slug:"/postgres/scripts",permalink:"/md/postgres/scripts",draft:!1,editUrl:"https://github.com/vincepr/md/blob/main/docs/postgres/scripts.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Gotchas",permalink:"/md/go/04gotchas"},next:{title:"Some Notes while starting to learn Rust",permalink:"/md/rust/02start"}},l={},c=[{value:"Kill long running queries",id:"kill-long-running-queries",level:3},{value:"Database size",id:"database-size",level:3},{value:"Create DDL for MCP or Agent comprehension",id:"create-ddl-for-mcp-or-agent-comprehension",level:3},{value:"Alternative minimal variant to save tokens",id:"alternative-minimal-variant-to-save-tokens",level:4},{value:"Adding comment support",id:"adding-comment-support",level:4}],d={toc:c};function p(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"postgres-scripts-of-daily-use"},"Postgres scripts of daily use"),(0,r.kt)("h3",{id:"kill-long-running-queries"},"Kill long running queries"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT pid, now() - pg_stat_activity.query_start AS duration, query\nFROM pg_stat_activity\nWHERE (now() - pg_stat_activity.query_start) > interval '2 minutes'; \n")),(0,r.kt)("p",null,"and kill it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT pg_terminate_backend(pid) as killed, query\nFROM pg_stat_activity\nWHERE (now() - pg_stat_activity.query_start) > interval '2 minutes'; \n")),(0,r.kt)("h3",{id:"database-size"},"Database size"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT schema_name, relname, pg_size_pretty(table_size) AS size, table_size\nFROM (SELECT n.nspname AS schema_name, c.relname, pg_relation_size(c.oid) AS table_size\n      FROM pg_catalog.pg_class c\n               JOIN pg_catalog.pg_namespace n ON c.relnamespace = n.oid) t\nWHERE schema_name NOT LIKE 'pg_%'\nORDER BY table_size DESC;\n")),(0,r.kt)("h3",{id:"create-ddl-for-mcp-or-agent-comprehension"},"Create DDL for MCP or Agent comprehension"),(0,r.kt)("p",null,"Great tool for use with an mcp or to quickly allow a agent to gather all required info about a database in a concise way."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"after postgres 16 go with ",(0,r.kt)("inlineCode",{parentName:"li"},"SELECT pg_get_tabledef(oid) FROM pg_class WHERE relkind = 'r';")," supports ",(0,r.kt)("strong",{parentName:"li"},"COMMENTS"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    'CREATE TABLE ' || n.nspname || '.' || c.relname || E' (\\n' ||\n    string_agg(definition, E',\\n' ORDER BY sort_order) ||\n    E'\\n);' AS create_table_sql\nFROM pg_class c\n         JOIN pg_namespace n ON n.oid = c.relnamespace  -- get schema name\n\n         JOIN (\n    -- column definitions\n    SELECT\n        a.attrelid,\n        '  ' || a.attname || ' ' ||\n        pg_catalog.format_type(a.atttypid, a.atttypmod) ||\n        CASE WHEN a.attnotnull THEN ' NOT NULL' ELSE '' END AS definition,\n        a.attnum AS sort_order  -- columns use attnum\n    FROM pg_attribute a\n    WHERE a.attnum > 0\n      AND NOT a.attisdropped\n\n    UNION ALL\n\n    -- primary key constraints\n    SELECT\n        con.conrelid AS attrelid,\n        '  ' || pg_get_constraintdef(con.oid) AS definition,\n        100000 * 1 + row_number() OVER (PARTITION BY con.conrelid ORDER BY con.oid) AS sort_order\n    FROM pg_constraint con\n    WHERE con.contype = 'p'\n\n    UNION ALL\n\n    -- foreign key constraints\n    SELECT\n        con.conrelid AS attrelid,\n        '  ' || pg_get_constraintdef(con.oid) AS definition,\n        100000 * 2 + row_number() OVER (PARTITION BY con.conrelid ORDER BY con.oid) AS sort_order\n    FROM pg_constraint con\n    WHERE con.contype = 'f'\n\n) defs ON defs.attrelid = c.oid\n\nWHERE c.relkind = 'r'\n  AND n.nspname NOT IN ('pg_catalog', 'information_schema')  -- skip system schemas\nGROUP BY n.nspname, c.relname;\n")),(0,r.kt)("p",null,"Example output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'-- script will return one row per table\nCREATE TABLE public.Authors (\n  Id integer NOT NULL,\n  Name text NOT NULL,\n  PRIMARY KEY (""Id"")\n);\nCREATE TABLE public.Books (\n  Id integer NOT NULL,\n  Title text NOT NULL,\n  Price numeric NOT NULL,\n  AuthorId integer NOT NULL,\n  PRIMARY KEY (""Id""),\n  FOREIGN KEY (""AuthorId"") REFERENCES ""Authors""(""Id"") ON DELETE CASCADE\n);\nCREATE TABLE public.Courses (\n  Id integer NOT NULL,\n  Title text NOT NULL,\n  PRIMARY KEY (""Id"")\n);\nCREATE TABLE public.StudentCourses (\n  StudentId integer NOT NULL,\n  CourseId integer NOT NULL,\n  EnrolledAt timestamp with time zone NOT NULL,\n  PRIMARY KEY (""StudentId"", ""CourseId""),\n  FOREIGN KEY (""CourseId"") REFERENCES ""Courses""(""Id"") ON DELETE CASCADE,\n  FOREIGN KEY (""StudentId"") REFERENCES ""Students""(""Id"") ON DELETE CASCADE\n);\nCREATE TABLE public.Students (\n  Id integer NOT NULL,\n  Name text NOT NULL,\n  PRIMARY KEY (""Id"")\n);\nCREATE TABLE internal.UserProfiles (\n  UserId integer NOT NULL,\n  FirstName text NOT NULL,\n  LastName text NOT NULL,\n  BirthDate date NOT NULL,\n  PRIMARY KEY (""UserId""),\n  FOREIGN KEY (""UserId"") REFERENCES ""Users""(""Id"") ON DELETE CASCADE\n);\nCREATE TABLE internal.Users (\n  Id integer NOT NULL,\n  Email text NOT NULL,\n  CreatedAt timestamp with time zone NOT NULL,\n  PRIMARY KEY (""Id"")\n);\n')),(0,r.kt)("h4",{id:"alternative-minimal-variant-to-save-tokens"},"Alternative minimal variant to save tokens"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT 'CREATE TABLE ' || relname || E' (\\n' ||\n       string_agg(\n               '  ' || a.attname || ' ' || pg_catalog.format_type(a.atttypid, a.atttypmod),\n               E',\\n'\n       ) || E'\\n);'\nFROM pg_class c\n         JOIN pg_attribute a ON a.attrelid = c.oid\nWHERE c.relkind = 'r'\n  AND c.relname !~ '^(pg|sql)_'\n  AND a.attnum > 0\n  AND NOT a.attisdropped\nGROUP BY relname;\n")),(0,r.kt)("h4",{id:"adding-comment-support"},"Adding comment support"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"WITH table_defs AS (\n    SELECT\n        n.nspname AS schema_name,\n        c.relname AS table_name,\n        'CREATE TABLE ' || n.nspname || '.' || c.relname || E' (\\n' ||\n        string_agg(definition, E',\\n' ORDER BY sort_order) ||\n        E'\\n);' AS create_table_sql,\n        c.oid AS table_oid\n    FROM pg_class c\n             JOIN pg_namespace n ON n.oid = c.relnamespace\n             JOIN (\n        -- column definitions\n        SELECT\n            a.attrelid,\n            '  ' || a.attname || ' ' ||\n            pg_catalog.format_type(a.atttypid, a.atttypmod) ||\n            CASE WHEN a.attnotnull THEN ' NOT NULL' ELSE '' END AS definition,\n            a.attnum AS sort_order\n        FROM pg_attribute a\n        WHERE a.attnum > 0\n          AND NOT a.attisdropped\n\n        UNION ALL\n\n        -- primary key constraints\n        SELECT\n            con.conrelid AS attrelid,\n            '  ' || pg_get_constraintdef(con.oid) AS definition,\n            100000 * 1 + row_number() OVER (PARTITION BY con.conrelid ORDER BY con.oid) AS sort_order\n        FROM pg_constraint con\n        WHERE con.contype = 'p'\n\n        UNION ALL\n\n        -- foreign key constraints\n        SELECT\n            con.conrelid AS attrelid,\n            '  ' || pg_get_constraintdef(con.oid) AS definition,\n            100000 * 2 + row_number() OVER (PARTITION BY con.conrelid ORDER BY con.oid) AS sort_order\n        FROM pg_constraint con\n        WHERE con.contype = 'f'\n    ) defs ON defs.attrelid = c.oid\n    WHERE c.relkind = 'r'\n      AND n.nspname NOT IN ('pg_catalog', 'information_schema')\n    GROUP BY n.nspname, c.relname, c.oid\n)\nSELECT\n    td.create_table_sql || E'\\n' ||\n    COALESCE(string_agg(\n                     'COMMENT ON TABLE ' || td.schema_name || '.' || td.table_name ||\n                     ' IS ' || quote_literal(d.description) || ';', E'\\n'\n             ), '') ||\n    E'\\n' ||\n    COALESCE(string_agg(\n                     'COMMENT ON COLUMN ' || td.schema_name || '.' || td.table_name || '.' || a.attname ||\n                     ' IS ' || quote_literal(d.description) || ';', E'\\n'\n             ), '') AS full_ddl\nFROM table_defs td\n         LEFT JOIN pg_description d ON d.objoid = td.table_oid AND d.classoid = 'pg_class'::regclass\n         LEFT JOIN pg_attribute a ON a.attrelid = td.table_oid AND a.attnum = d.objsubid\nGROUP BY td.schema_name, td.table_name, td.create_table_sql\nORDER BY td.schema_name, td.table_name;\n")),(0,r.kt)("p",null,"Output would be"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"CREATE TABLE public.Users (\n  Id integer NOT NULL,\n  Email text NOT NULL,\n  CreatedAt timestamp with time zone NOT NULL,\n  PRIMARY KEY (\"Id\")\n);\nCOMMENT ON TABLE public.Users IS 'Hidden table for internal use only';\n")))}p.isMDXComponent=!0}}]);