"use strict";(self.webpackChunkmd=self.webpackChunkmd||[]).push([[9578],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>f});var n=r(7294);function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}var o=n.createContext({}),c=function(e){var t=n.useContext(o),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},u=function(e){var t=c(e.components);return n.createElement(o.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,i=e.mdxType,a=e.originalType,o=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(r),m=i,f=d["".concat(o,".").concat(m)]||d[m]||p[m]||a;return r?n.createElement(f,s(s({ref:t},u),{},{components:r})):n.createElement(f,s({ref:t},u))}));function f(e,t){var r=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=r.length,s=new Array(a);s[0]=m;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l[d]="string"==typeof e?e:i,s[1]=l;for(var c=2;c<a;c++)s[c]=r[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},7629:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>l,toc:()=>c});var n=r(7462),i=(r(7294),r(3905));const a={},s="Refactoring exercise in Csharp part 1",l={unversionedId:"csharp/examples/refactoring/refactoring1",id:"csharp/examples/refactoring/refactoring1",title:"Refactoring exercise in Csharp part 1",description:"goal is to refactor to make code testable.",source:"@site/docs/csharp/examples/refactoring/refactoring1.md",sourceDirName:"csharp/examples/refactoring",slug:"/csharp/examples/refactoring/refactoring1",permalink:"/md/csharp/examples/refactoring/refactoring1",draft:!1,editUrl:"https://github.com/vincepr/md/blob/main/docs/csharp/examples/refactoring/refactoring1.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"ref, in, out keyword in Csharp",permalink:"/md/csharp/examples/ref_in_out"},next:{title:"Refactoring exercise in Csharp part 1",permalink:"/md/csharp/examples/refactoring/refactoring2"}},o={},c=[{value:"Old code",id:"old-code",level:2},{value:"Steps to take",id:"steps-to-take",level:2},{value:"DateTime.Now",id:"datetimenow",level:3},{value:"Interface for the ClientRepository",id:"interface-for-the-clientrepository",level:3},{value:"UserCreditService",id:"usercreditservice",level:3},{value:"UserDataAccess the static method we are not allowed to touch",id:"userdataaccess-the-static-method-we-are-not-allowed-to-touch",level:3},{value:"The new constructor",id:"the-new-constructor",level:3},{value:"new code so far",id:"new-code-so-far",level:2}],u={toc:c};function d(e){let{components:t,...r}=e;return(0,i.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"refactoring-exercise-in-csharp-part-1"},"Refactoring exercise in Csharp part 1"),(0,i.kt)("p",null,"goal is to refactor to make code testable."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Immagine for a given codebase we want to make some logic-changes to ",(0,i.kt)("inlineCode",{parentName:"p"},"UserServices.cs")," but cant most other parts of the codebase.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"No business logic should be touched. (everything should behave as before logically)"))),(0,i.kt)("h2",{id:"old-code"},"Old code"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},'public class UserService {\n    public bool AddUser(string firstname, string surname, string email, DateTime dateOfBirth, int clientId) {\n        if (string.IsNullOrEmpty(firstname) || string.IsNullOrEmpty(surname))\n            return false;\n        \n        if (!email.Contains("@") && !email.Contains("."))\n            return false;\n        \n        var now = DateTime.Now;\n        int age = now.Year - dateOfBirth.Year;\n        if (now.Month < dateOfBirth.Month \n            || (now.Month == dateOfBirth.Month && now.Day < dateOfBirth.Day))\n        {\n            age--;\n        }\n\n        if (age <21)\n            return false;\n\n        var clientRepository = new ClientRepository();\n        var client = clientRepository.GetById(clientId);\n\n        var user = new User{\n            Client = client,\n            DateOfBirth = dateOfBirth,\n            EmailAdress = email,\n            Firstname = firstname,\n            Surname = surname\n        };\n\n        if (client.Name == "VeryImportantClient"){\n            // skipp credit check\n            user.HasCreditLimit = false;\n        }\n        else if (client.Name == "ImportantClient"){\n            // credit check and double credit limit\n            user.HasCreditLimit = true;\n            using (var userCreditService = new IserCreditServiceClient()){\n                var creditLimit =userCreditService.GetCreditLimit(user.Firstname, user.Surname, user.DateOfBirth);\n                creditLimit = creditLimit*2;\n                user.CreditLimit = creditLimit;\n            } \n        }else {\n            // normal credit check\n            user.HashcCreditLimit = true;\n            using (var userCreditService = new UserCreditServiceClient()){\n                var creditLimit =userCreditService.GetCreditLimit(user.Firstname, user.Surname, user.DateOfBirth);\n                user.CreditLimit = creditLimit;\n            }\n        }\n\n        if (user.HasCreditLimit && user.CreditLimit < 500)\n            return false\n        \n        UserDataAccess.AddUser(user);\n        return true;\n    }\n}\n')),(0,i.kt)("h2",{id:"steps-to-take"},"Steps to take"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"There are no unit tests currently. So first goal would be to write unit tests, that pass the existing logic. So breaking for existing behavior becomes aparent.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"var now = DateTime.Now")," is not really testable")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"var clientRepository = new ClientRepository()")," gets created new every request")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"using (var userCreditService = new UserCreditServiceClient())")," not testable like this")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"UserDataAccess.AddUser(user)")," is not testable like this"))),(0,i.kt)("h3",{id:"datetimenow"},"DateTime.Now"),(0,i.kt)("p",null,"Avoid ",(0,i.kt)("inlineCode",{parentName:"p"},"DateTime.Now")," as it is really hard to write tests like this. Since tests might excede limits, timezones exist, Testing Containers might report wrong timestamps etc."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"create a new ",(0,i.kt)("inlineCode",{parentName:"li"},"/Services/IDateTimeProvider.cs"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},"public interface IDateTimeProvider{\n    public DateTime DateTimeNow { get; }\n}\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"and an implementaitonw ",(0,i.kt)("inlineCode",{parentName:"li"},"/Services/DateTimeProvider.cs"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},"public interface DateTimeProvider : IDateTimeProvider{\n    public DateTime DateTimeNow => DateTime.Now\n}\n")),(0,i.kt)("p",null,"Now the DateTimeProvider is mockable in our unit tests."),(0,i.kt)("h3",{id:"interface-for-the-clientrepository"},"Interface for the ClientRepository"),(0,i.kt)("p",null,"We create an Interface for the ClientRepository, to make it properly mockable aswell:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"/Repositories/IClientRepository.cs"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},"public interface IClientRepository{\n    Client GetById(int id);\n}\n")),(0,i.kt)("p",null,"By injecting the clientRepository we can also avoid always fully recreating the Repository."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},"var clientRepository = new ClientRepository();\nvar client = clientRepository.GetById(clientId);\n// becomes just:\nvar client = _clientRepository.GetById(clientId);\n")),(0,i.kt)("h3",{id:"usercreditservice"},"UserCreditService"),(0,i.kt)("p",null,"Similar to above there is (in this case) no need to always recreate the Service for each new user."),(0,i.kt)("p",null,"So we again just put it in an readonly attribute and directly call that without any of the ",(0,i.kt)("inlineCode",{parentName:"p"},"using (var service = new Service())")),(0,i.kt)("h3",{id:"userdataaccess-the-static-method-we-are-not-allowed-to-touch"},"UserDataAccess the static method we are not allowed to touch"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"UserDataAccess")," is in this case a static class we can not change (because were not allowed to)."),(0,i.kt)("p",null,"A solution for a Situation like this is: to create an Interface and a Proxy- /wrapper- Class for UserDataAcess."),(0,i.kt)("p",null,"The Proxy Class will call the static-method but it itself becomes testable/mockable. Without actually changing the underlying class."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"DataAccess/IUserDataAccess"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},"public interface IUserDataAccess{\n    void AddUser(User user);\n}\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"DataAccess/UserDataAccessProxy"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},"public class UserDataAccessProxy : IUserDataAccess{\n    void AddUser(User user)\n        => UserDataAcess.AddUser(user); // we just call the off limit method in here\n}\n")),(0,i.kt)("h3",{id:"the-new-constructor"},"The new constructor"),(0,i.kt)("p",null,"as per request we are not allowed to change the Code that calls our UserService."),(0,i.kt)("p",null,"This means we cant just do a Constructor and inject our 4 new Interface Implementations."),(0,i.kt)("p",null,"The best way here is to add 2 constructors, one where one can provivde the 4 Implementors. And one without any params that just implements our above created ones."),(0,i.kt)("h2",{id:"new-code-so-far"},"new code so far"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-cs"},'public class UserService{\n\n    private readonly IDateTimeProvider _dateTimeProvider;\n    private readonly IClientRepository _clientRepository;\n    private readonly IUserCreditService _userCreditService;\n    private readonly IUserDataAccess _userDataAccess;\n\n    public UserService() :\n        this(\n            new DateTimeProvider(),\n            new ClientRepository(),\n            new UserCreditService(),\n            new UserDataAccessProxy()\n        ){}\n\n    public UserService(IDateTimeProvider dateTimeProvider, IClientRepository clientRepository, IUserCreditService userCreditService, IUserDataAccess userDataAccess){\n        _dateTimeProvider = dateTimeProvider;\n        _clientRepository = clientRepository;\n        _userCreditService = userCreditService;\n        _userDataAccess = userDataAccess;\n    }\n\n    public bool AddUser(string firstname, string surname, string email, DateTime dateOfBirth, int clientId){\n        if (string.IsNullOrEmpty(firstname) || string.IsNullOrEmpty(surname))\n            return false;\n        \n        if (!email.Contains("@") && !email.Contains("."))\n            return false;\n        \n        var now = _dateTimeProvider.DateTimeNow;\n        int age = now.Year - dateOfBirth.Year;\n        if (now.Month < dateOfBirth.Month \n            || (now.Month == dateOfBirth.Month && now.Day < dateOfBirth.Day))\n        {\n            age--;\n        }\n\n        if (age <21)\n            return false;\n\n        var client = _clientRepository.GetById(clientId);\n\n        var user = new User{\n            Client = client,\n            DateOfBirth = dateOfBirth,\n            EmailAdress = email,\n            Firstname = firstname,\n            Surname = surname\n        };\n\n        if (client.Name == "VeryImportantClient"){\n            // skipp credit check\n            user.HasCreditLimit = false;\n        }\n        else if (client.Name == "ImportantClient"){\n            // credit check and double credit limit\n            user.HasCreditLimit = true;\n\n            var creditLimit = _userCreditService.GetCreditLimit(user.Firstname, user.Surname, user.DateOfBirth);\n            creditLimit = creditLimit*2;\n            user.CreditLimit = creditLimit;\n        }else {\n            // normal credit check\n            user.HasCreditLimit = true;\n\n            var creditLimit = _userCreditService.GetCreditLimit(user.Firstname, user.Surname, user.DateOfBirth);\n            user.CreditLimit = creditLimit;\n        }\n\n        if (user.HasCreditLimit && user.CreditLimit < 500)\n            return false;\n        \n        _userDataAccess.AddUser(user);\n        return true;\n    }\n}\n')),(0,i.kt)("p",null,"Additional thoughts so far"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},'if (!email.Contains("@") && !email.Contains("."))')," is not really a proper way to check for if the email string is a proper email",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"but changes to it will affect business logic. So it ",(0,i.kt)("strong",{parentName:"li"},"must not")," be part of the current refactoring. But should always be it's own refactor/commit etc."))),(0,i.kt)("li",{parentName:"ul"},"the whole way how ",(0,i.kt)("inlineCode",{parentName:"li"},'"VeryImportantClient" || "ImportantClient" || Default')," is handled is a violation of the ",(0,i.kt)("strong",{parentName:"li"},"Open Closed")," Principle. And should be separated.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"this can be changed without affecting business logic so it should be refactored.")))))}d.isMDXComponent=!0}}]);